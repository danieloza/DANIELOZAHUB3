name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Semver bump"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run test gate
        env:
          TELEGRAM_BOT_TOKEN: "dummy-token-for-ci"
        run: |
          pytest -q tests

      - name: Bump version and generate notes
        shell: pwsh
        run: |
          ./scripts/release.ps1 -Bump "${{ github.event.inputs.bump }}"

      - name: Commit release artifacts
        run: |
          VERSION="$(tr -d '\r\n' < VERSION)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add VERSION CHANGELOG.md RELEASE_NOTES.md
          git commit -m "release: v${VERSION}"
          git tag "v${VERSION}"
          git push origin HEAD
          git push origin "v${VERSION}"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="$(tr -d '\r\n' < VERSION)"
          gh release create "v${VERSION}" --title "v${VERSION}" --notes-file RELEASE_NOTES.md
